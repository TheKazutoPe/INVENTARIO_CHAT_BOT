{% extends "base.html" %}
{% block title %}Materiales Aver铆a #{{ bitacora.codigo_bd }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
{% endblock %}

{% block navbar_right %}
<span class="badge bg-dark rounded-pill">#{{ bitacora.codigo_bd }}</span>
{% endblock %}

{% block content %}
<div class="page-wrapper" data-bitacora-id="{{ bitacora.id }}">

  <div class="card card-custom mb-3 border-0 shadow-sm animate__animated animate__fadeIn">
    <div class="card-body p-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="d-flex align-items-center">
            <span class="badge bg-primary me-2"><i class="bi bi-ticket-fill"></i> #{{ bitacora.codigo_bd }}</span>
            <span class="badge {% if bitacora.is_cerrada %}bg-success{% else %}bg-warning text-dark{% endif %}">
                {{ bitacora.estado_textual_bd or "EN PROCESO" }}
            </span>
        </div>
      </div>

      <h5 class="fw-bold text-dark mb-1">
        {{ bitacora.titulo_bd or "Incidencia sin t铆tulo" }}
      </h5>
      <div class="small text-muted mb-3">
        <i class="bi bi-geo-alt-fill text-danger"></i>
        {{ bitacora.distrito_bd or "Sin distrito" }}
        {% if bitacora.zona_bd %} - {{ bitacora.zona_bd }}{% endif %}
      </div>

      <div class="bg-light rounded-3 p-3 border">
        <div class="row g-2 small">
          <div class="col-6">
            <span class="text-secondary d-block fw-bold" style="font-size:0.7rem">TIPO AVERA</span>
            <span class="text-dark">{{ bitacora.tipoaveria_bd or "-" }}</span>
          </div>
          <div class="col-6">
             <span class="text-secondary d-block fw-bold" style="font-size:0.7rem">CLIENTE / SITIO</span>
             <span class="text-dark text-truncate d-block">
               {{ bitacora.nombrecliente_bd or bitacora.nombresite_bd or "-" }}
             </span>
          </div>
          <div class="col-6 mt-2">
             <span class="text-secondary d-block fw-bold" style="font-size:0.7rem">MAPA</span>
             {% if bitacora.lat_bd and bitacora.lon_bd %}
               <a href="https://maps.google.com/?q={{ bitacora.lat_bd }},{{ bitacora.lon_bd }}" target="_blank" class="text-decoration-none fw-bold text-primary">
                 <i class="bi bi-map"></i> Ver ubicaci贸n
               </a>
             {% else %}
               <span class="text-muted">-</span>
             {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card card-custom p-3 border-0 shadow-sm">

    <div class="row g-2 mb-3">
      <div class="col-5">
        <label class="form-label small text-uppercase text-muted fw-bold mb-1" style="font-size: 0.65rem;">Origen</label>
        <select id="origen" class="form-select form-select-sm fw-bold border-0 bg-light py-2">
          <option value="claro" selected> Claro</option>
          <option value="cicsa"> Cicsa</option>
        </select>
      </div>
      <div class="col-7">
        <label class="form-label small text-uppercase text-muted fw-bold mb-1" style="font-size: 0.65rem;">Brigada Responsable</label>
        <select id="select-brigada" class="form-select form-select-sm fw-bold border-0 bg-light py-2 text-truncate">
            {% for bri in brigadas %}
              <option value="{{ bri }}">{{ bri }}</option>
            {% endfor %}
        </select>
      </div>
    </div>

    <div class="mb-3 search-container position-relative">
      <label class="form-label small text-muted mb-1">Buscar material</label>
      <div class="input-group">
        <span class="input-group-text bg-white border-end-0 rounded-start-3 ps-3"><i class="bi bi-search"></i></span>
        <input
          id="search-material"
          type="search"
          class="form-control form-control-lg-custom border-start-0"
          placeholder="Escribe nombre, c贸digo o alias..."
          autocomplete="off"
        >
      </div>
      <div id="search-results" class="list-group position-absolute w-100 mt-1 d-none shadow-lg" style="z-index: 1050; max-height: 250px; overflow-y: auto;"></div>
    </div>

    <div id="selection-card" class="d-none animate__animated animate__fadeIn">
      <div class="alert alert-primary border-0 d-flex align-items-start p-2 mb-3" role="alert" style="border-radius: 12px;">
        <i class="bi bi-check-circle-fill text-primary mt-1 me-2 fs-5"></i>
        <div class="w-100">
          <div class="fw-bold text-dark" id="sel-desc">Cable Fibra</div>
          <div class="d-flex justify-content-between mt-1">
             <span class="small text-primary opacity-75">C贸d: <span id="sel-code">---</span></span>
             <span class="badge bg-white text-primary border">Unidad: <span id="sel-unit">---</span></span>
          </div>
        </div>
        <button type="button" class="btn-close ms-2" aria-label="Close" id="btn-cancel-sel"></button>
      </div>

      <div class="row g-2">
        <div class="col-5">
          <div class="quantity-control d-flex align-items-center bg-light rounded-3 p-1">
            <button class="btn btn-quantity bg-white shadow-sm border-0 text-primary fw-bold" style="width: 40px; height: 40px;" id="btn-minus"><i class="bi bi-dash"></i></button>
            <input id="cantidad" type="number" class="form-control border-0 bg-transparent text-center fw-bold p-0" value="1">
            <button class="btn btn-quantity bg-white shadow-sm border-0 text-primary fw-bold" style="width: 40px; height: 40px;" id="btn-plus"><i class="bi bi-plus"></i></button>
          </div>
        </div>
        <div class="col-7">
          <button id="btn-guardar" class="btn btn-primary w-100 h-100 fw-bold shadow-sm rounded-3">
            AGREGAR <i class="bi bi-arrow-down-circle ms-1"></i>
          </button>
        </div>
      </div>
    </div>

    <div id="empty-state" class="text-center py-3 text-muted">
      <small>Busca y selecciona un material para habilitar el guardado.</small>
    </div>
  </div>

  <div class="mt-4">
    <h6 class="text-muted text-uppercase small fw-bold ms-2 mb-3">Materiales en esta Aver铆a</h6>

    <div id="materiales-list" class="material-history-list mobile-list d-flex flex-column gap-2"></div>

    <div class="card shadow-sm border-0 desktop-table overflow-hidden d-none d-md-block">
      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light small text-muted">
            <tr>
              <th>C贸d.</th>
              <th>Descripci贸n</th>
              <th>Brigada</th>
              <th>Cant.</th>
              <th>Unidad</th>
              <th>Hora</th>
              <th class="text-end">Acci贸n</th>
            </tr>
          </thead>
          <tbody id="materiales-body"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>
  <script src="{{ url_for('static', filename='materiales.js') }}"></script>
{% endblock %}